{% comment %} Quote Button - Hiển thị nút quote dựa trên metafield {% endcomment %}
<script>
console.log('Quote Button Loading...');

document.addEventListener('DOMContentLoaded', function() {
  console.log('Quote Button - DOM Ready');
  
  // Chỉ chạy trên trang product
  if (!window.location.pathname.includes('/products/')) {
    console.log('Not a product page, skipping');
    return;
  }
  
  // Lấy metafield configuration
  let quoteConfig = null;
  
  {% if shop.metafields.quote_snap.configuration %}
    try {
      const metafieldValue = {{ shop.metafields.quote_snap.configuration.value | json }};
      console.log('Raw shop metafield value:', metafieldValue);
      quoteConfig = typeof metafieldValue === 'string' ? JSON.parse(metafieldValue) : metafieldValue;
      console.log('Parsed shop metafield:', quoteConfig);
    } catch (e) {
      console.error('Error parsing shop metafield:', e);
    }
  {% else %}
    console.log('No metafield found');
  {% endif %}
  
  
  // Kiểm tra nếu không active (chỉ khi có metafield)
  if (quoteConfig && quoteConfig.hasOwnProperty('isActive') && !quoteConfig.isActive) {
    console.log('Quote button is not active (disabled by metafield)');
    return;
  }
  
  console.log('Quote button is active, proceeding...');
  console.log('Final config being used:', quoteConfig);
  console.log('Config details:');
  console.log('- displayRule:', quoteConfig.displayRule);
  console.log('- buttonLabel:', quoteConfig.buttonLabel);
  console.log('- alignment:', quoteConfig.alignment);
  console.log('- fontSize:', quoteConfig.fontSize);
  console.log('- cornerRadius:', quoteConfig.cornerRadius);
  console.log('- textColor:', quoteConfig.textColor);
  console.log('- buttonColor:', quoteConfig.buttonColor);
  console.log('- isActive:', quoteConfig.isActive);
  
  // Kiểm tra displayRule specific
  if (quoteConfig.displayRule === 'specific' && quoteConfig.specificProducts) {
    const currentProductId = {{ product.id | json }};
    const currentProductGid = `gid://shopify/Product/${currentProductId}`;
    
    console.log('Checking specific products rule...');
    console.log('Current product ID:', currentProductId);
    console.log('Current product GID:', currentProductGid);
    console.log('Specific products list:', quoteConfig.specificProducts);
    
    // Kiểm tra xem sản phẩm hiện tại có trong danh sách không
    const isProductAllowed = quoteConfig.specificProducts.some(product => {
      // So sánh theo GID
      if (product.id === currentProductGid) return true;

      return false;
    });
    
    console.log('Is product allowed:', isProductAllowed);
    
    if (!isProductAllowed) {
      console.log('Current product not in specific products list, skipping quote button');
      return;
    }
    
    console.log('Product is in specific list, showing quote button');
  }
  
  
  
  // Chuyển HSB sang RGB
  function hsbToRgb(h, s, b) {
    h = h / 360;
    const c = b * s;
    const x = c * (1 - Math.abs((h * 6) % 2 - 1));
    const m = b - c;
    
    let r, g, bl;
    if (h < 1/6) { r = c; g = x; bl = 0; }
    else if (h < 2/6) { r = x; g = c; bl = 0; }
    else if (h < 3/6) { r = 0; g = c; bl = x; }
    else if (h < 4/6) { r = 0; g = x; bl = c; }
    else if (h < 5/6) { r = x; g = 0; bl = c; }
    else { r = c; g = 0; bl = x; }
    
    return {
      r: Math.round((r + m) * 255),
      g: Math.round((g + m) * 255),
      b: Math.round((bl + m) * 255)
    };
  }
  
  // Tính màu
  console.log('Processing colors...');
  console.log('Raw buttonColor from config:', quoteConfig.buttonColor);
  console.log('Raw textColor from config:', quoteConfig.textColor);
  
  const buttonColorHsb = {
    hue: quoteConfig.buttonColor?.hue ?? 40,
    saturation: quoteConfig.buttonColor?.saturation ?? 1,
    brightness: quoteConfig.buttonColor?.brightness ?? 1
  };
  
  const textColorHsb = {
    hue: quoteConfig.textColor?.hue ?? 0,
    saturation: quoteConfig.textColor?.saturation ?? 0,
    brightness: quoteConfig.textColor?.brightness ?? 1
  };
  
  console.log('Processed buttonColor HSB:', buttonColorHsb);
  console.log('Processed textColor HSB:', textColorHsb);
  
  const buttonColor = hsbToRgb(
    buttonColorHsb.hue,
    buttonColorHsb.saturation,
    buttonColorHsb.brightness
  );
  
  const textColor = hsbToRgb(
    textColorHsb.hue,
    textColorHsb.saturation,
    textColorHsb.brightness
  );
  
  console.log('Final buttonColor RGB:', buttonColor);
  console.log('Final textColor RGB:', textColor);
  
  // Chuyển đổi alignment từ flex values sang CSS
  console.log('Processing alignment...');
  console.log('Raw alignment from config:', quoteConfig.alignment);
  
  let containerStyle = '';
  let buttonStyle = '';
  
  if (quoteConfig.alignment === 'flex-end' || quoteConfig.alignment === 'right') {
    containerStyle = 'text-align: right;';
    console.log('Applied alignment: right');
  } else if (quoteConfig.alignment === 'flex-start' || quoteConfig.alignment === 'left') {
    containerStyle = 'text-align: left;';
    console.log('Applied alignment: left');
  } else {
    containerStyle = 'text-align: center;';
    console.log('Applied alignment: center');
  }
  
  console.log('Font size from config:', quoteConfig.fontSize);
  console.log('Corner radius from config:', quoteConfig.cornerRadius);
  console.log('Button label from config:', quoteConfig.buttonLabel);
  
  const quoteButtonHtml = `
    <div class="quote-button-container" style="${containerStyle} margin: 15px 0;">
      <button 
        class="quote-request-button" 
        style="
          background-color: rgb(${buttonColor.r}, ${buttonColor.g}, ${buttonColor.b});
          color: rgb(${textColor.r}, ${textColor.g}, ${textColor.b});
          font-size: ${quoteConfig.fontSize}px;
          border-radius: ${quoteConfig.cornerRadius}px;
          border: none;
          padding: 12px 24px;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s ease;
          min-width: 200px;
          width: 100%;
          max-width: 400px;
          display: inline-block;
          text-align: center;
          text-decoration: none;
          line-height: 1.4;
          box-sizing: border-box;
        "
        onmouseover="this.style.opacity='0.8'; this.style.transform='translateY(-1px)'" 
        onmouseout="this.style.opacity='1'; this.style.transform='translateY(0)'"
        onclick="handleQuoteRequest()"
      >
        ${quoteConfig.buttonLabel || 'Request Quote'}
      </button>
    </div>
  `;
  
  // Xử lý click
  window.handleQuoteRequest = function() {
    const productData = {
      id: {{ product.id | json }},
      title: {{ product.title | json }},
      handle: {{ product.handle | json }},
      price: {{ product.price | json }},
      url: window.location.href
    };
    
    console.log('Quote requested for:', productData);
    alert('Quote request submitted for: ' + productData.title);
    
    // Trigger custom event
    document.dispatchEvent(new CustomEvent('quoteRequested', {
      detail: { product: productData, config: quoteConfig }
    }));
  };
  
  // Tìm và chèn nút
  const addToCartButton = document.querySelector('button[name="add"], [data-testid="add-to-cart"], .btn-product-add, form[action*="/cart/add"] button[type="submit"]');
  
  if (addToCartButton) {
    console.log('Found Add to Cart button, inserting quote button');
    
    // Tìm container chứa Add to Cart button để chèn nút ở cùng level
    let insertTarget = addToCartButton.parentNode;
    
    // Nếu Add to Cart nằm trong form, chèn sau form
    const parentForm = addToCartButton.closest('form[action*="/cart/add"]');
    if (parentForm) {
      insertTarget = parentForm;
    }
    
    if (quoteConfig.position === 'replace-button') {
      addToCartButton.style.display = 'none';
      insertTarget.insertAdjacentHTML('afterend', quoteButtonHtml);
    } else if (quoteConfig.position === 'above-button') {
      insertTarget.insertAdjacentHTML('beforebegin', quoteButtonHtml);
    } else { // under-button (default)
      insertTarget.insertAdjacentHTML('afterend', quoteButtonHtml);
    }
  } else {
    console.log('Add to Cart not found, trying product form');
    const productForm = document.querySelector('form[action*="/cart/add"], .product-form, .product');
    if (productForm) {
      productForm.insertAdjacentHTML('beforeend', quoteButtonHtml);
    } else {
      // Cuối cùng, chèn vào cuối body nếu không tìm thấy gì
      document.body.insertAdjacentHTML('beforeend', quoteButtonHtml);
    }
  }
  
  console.log('Quote button setup completed');
});
</script>

{% schema %}
{
  "name": "Quote Button",
  "target": "head",
  "templates": ["product"]
}
{% endschema %}

